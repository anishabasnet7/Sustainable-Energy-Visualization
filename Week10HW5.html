<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>California WildFires (2013-2020)</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f9f9f9; }
        h1 { text-align: center; color: #333; }
        .container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
        }
        #map-view, #chart-view {
            background: white;
            padding: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            border-radius: 8px;
        }

        .county {
            fill: #e0e0e0;
            stroke: #fff;
            stroke-width: 0.5px;
        }
        
        .fire-circle {
            fill: #d62728; /*fire*/
            stroke: none;
            opacity: 0.4; /*transparent when overlapping*/
            cursor: pointer;
        }
        
        .fire-circle:hover {
            stroke: #000;
            stroke-width: 1px;
            opacity: 1;
        }

        .bar { fill: #ff7f0e; }
        .bar:hover { fill: #d62728; }

        /*tooltip*/
        #tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px;
            border-radius: 4px;
            pointer-events: none;
            opacity: 0;
            font-size: 12px;
        }
    </style>
</head>
<body>

    <h1>California WildFires (2013-2020)</h1>
    <div id="text-container">
        <h3>Relevant Data Attributes</h3>
        <ul>
            <li>
                <strong>Latitude & Longitude</strong> (<em>Spatial</em>)<br>
                For knowing where fires are located. They help us to plot precise geometric points on a map,
                so we know clusters and density more accurately than text-based location descriptions.
            </li>
             <li style="margin-top: 10px;">
                <strong>AcresBurned</strong> (<em>Quantitative</em>)<br>
                The proxy for magnitude. To know where the "largest" fires happen, we distinguish between minor incidents and major disasters. 
                This attribute allows us to encode size to highlight outliers.
            </li>
            <li style="margin-top: 10px;">
                <strong>Started</strong> (<em>Temporal</em>)<br>
                For budget planning. By extracting Month from this timestamp, we aggregate incident counts to identify trends.
            </li>
            <li style="margin-top: 10px;">
                <strong>Name</strong> (<em>Categorical / Nominal</em>)<br>
                Identity
                When user sees a massive outlier on map, they will know the specific name (e.g., "Camp Fire").
            </li>
            <li style="margin-top: 10px;">
                <strong>Counties</strong> (<em>Categorical / Nominal</em>)<br>
                Provides administrative context.
            </li>
        </ul>
        <h3>Spatial(Map)</h3>
        <p>
            The coordinator's need to identify where fires occur and distinguish magnitude (outliers). 
            I used the Proportional Symbol Map where geometry of California serves is the base layer.
            Also, individual fires are encoded as circles by their specific Latitude and Longitude. 
        </p>
        <p>
            The area of each circle is mapped to the <code>AcresBurned</code> attribute. 
            The coordinator can instantly spot the largest, most dangerous fires (spatial outliers) without reading. 
            Also, circles are rendered in red with 50% opacity. There will not be overlapping points solving the task of locating fire clusters.
        </p>

        <h3>Temporal(Bar)</h3>
        <p>
            Here, the data is aggregated by counting the number of incidents per month so coordinator can task to budget and resource plan based on seasonality.             
        </p>
        <p>
            X-axis is the cyclic temporal attribute (Months, Jan - Dec) and Y-axis is the frequency of fires. It is 
            most accurate visual comparison of values where user can scan the chart and see exactly when the fire season peaks 
            (eg: comparing August vs. November) to decide when to allocate the maximum number of firefighters on standby.
        </p>
    </div>

    <div id="tooltip"></div>

    <div class="container">
        <!--Map-->
        <div id="map-view">
            <h3>Fire Location & Magnitude</h3>
        </div>

        <!--BarChart-->
        <div id="chart-view">
            <h3>Frequency</h3>
        </div>
    </div>

<script>
    const widthMap = 500;
    const heightMap = 600;
    const widthChart = 500;
    const heightChart = 600;
    const margin = {top: 20, right: 30, bottom: 40, left: 40};

    //load data
    Promise.all([
        d3.json("https://raw.githubusercontent.com/codeforamerica/click_that_hood/master/public/data/california-counties.geojson"),  //geojson for cali counties
        d3.csv("California_Fire_Incidents.csv")
    ]).then(function(files) {
        
        const caGeoData = files[0];
        const fireData = files[1];

        //clean data
        const cleanFireData = fireData.map(d => {
            return {
                id: d.UniqueId,
                name: d.Name,
                acres: +d.AcresBurned, //convert to number
                lat: +d.Latitude,
                lon: +d.Longitude,
                month: new Date(d.Started).toLocaleString('default', { month: 'short' }), //extract montjh name
                monthIndex: new Date(d.Started).getMonth() //sorting from 0-11
            };
        }).filter(d => 
            !isNaN(d.acres) && d.acres > 0 && //filter bad data (coordinates outside CA or 0 acres)
            d.lat > 32 && d.lat < 43 && 
            d.lon > -125 && d.lon < -114
        );

        drawMap(caGeoData, cleanFireData);
        drawBarChart(cleanFireData);

    }).catch(function(err) {
        console.error("Error", err);
    });

    //1:Map
    function drawMap(geoData, data) {
        const svg = d3.select("#map-view")
            .append("svg")
            .attr("width", widthMap)
            .attr("height", heightMap);

        //centering map on Cali
        const projection = d3.geoMercator()
            .center([-120, 37]) //approx center of CA
            .scale(2500)        //zoom level
            .translate([widthMap / 2, heightMap / 2]);

        const path = d3.geoPath().projection(projection);

        //counties
        svg.selectAll("path")
            .data(geoData.features)
            .enter().append("path")
            .attr("class", "county")
            .attr("d", path);

        //scale for bubble size - scaleSqrt for circles so area is proportional to data, not radius
        const sizeScale = d3.scaleSqrt()
            .domain([0, d3.max(data, d => d.acres)])
            .range([2, 25]); //min pixel size 2, max pixel size 25

        const circles = svg.selectAll("circle")
            .data(data.sort((a, b) => b.acres - a.acres))
            .enter().append("circle")
            .attr("class", "fire-circle")
            .attr("cx", d => projection([d.lon, d.lat])[0])
            .attr("cy", d => projection([d.lon, d.lat])[1])
            .attr("r", d => sizeScale(d.acres))
            .on("mouseover", function(event, d) {
                //tooltip interaction
                d3.select("#tooltip")
                    .style("opacity", 1)
                    .html(`<strong>${d.name} Fire</strong><br>Acres: ${d.acres}<br>Month: ${d.month}`)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 28) + "px");
                d3.select(this).style("stroke", "black");
            })
            .on("mouseout", function() {
                d3.select("#tooltip").style("opacity", 0);
                d3.select(this).style("stroke", "none");
            });
    }

    //2:BAR
    function drawBarChart(data) {
        //counting fires per month
        const monthCounts = d3.rollups(data, v => v.length, d => d.monthIndex)
            .sort((a, b) => a[0] - b[0]); //sorting by Jan-Dec index
        
        //convert back to array of objects with names
        const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        const aggData = monthCounts.map(d => ({
            month: monthNames[d[0]],
            count: d[1]
        }));

        const svg = d3.select("#chart-view")
            .append("svg")
            .attr("width", widthChart)
            .attr("height", heightChart);

        const innerWidth = widthChart - margin.left - margin.right;
        const innerHeight = heightChart - margin.top - margin.bottom;

        const g = svg.append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        //scales
        const x = d3.scaleBand()
            .domain(monthNames)
            .range([0, innerWidth])
            .padding(0.2);

        const y = d3.scaleLinear()
            .domain([0, d3.max(aggData, d => d.count)])
            .range([innerHeight, 0]);

        //axis
        g.append("g")
            .attr("transform", `translate(0,${innerHeight})`)
            .call(d3.axisBottom(x));

        g.append("g")
            .call(d3.axisLeft(y));

        //bar
        g.selectAll(".bar")
            .data(aggData)
            .enter().append("rect")
            .attr("class", "bar")
            .attr("x", d => x(d.month))
            .attr("y", d => y(d.count))
            .attr("width", x.bandwidth())
            .attr("height", d => innerHeight - y(d.count))
            .on("mouseover", function(event, d) {
                d3.select("#tooltip")
                    .style("opacity", 1)
                    .html(`<strong>${d.month}</strong><br>Incidents: ${d.count}`)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 28) + "px");
                d3.select(this).style("fill", "#d62728");
            })
            .on("mouseout", function() {
                d3.select("#tooltip").style("opacity", 0);
                d3.select(this).style("fill", "#ff7f0e");
            });
            
        //label
        g.append("text")
             .attr("x", innerWidth / 2)
             .attr("y", innerHeight + 35)
             .style("text-anchor", "middle")
             .text("Month");
             
        g.append("text")
             .attr("transform", "rotate(-90)")
             .attr("y", 0 - margin.left + 12)
             .attr("x", 0 - (innerHeight / 2))
             .style("text-anchor", "middle")
             .style("font-size", "12px")
             .text("Number of Fires");
    }

</script>
</body>
</html>